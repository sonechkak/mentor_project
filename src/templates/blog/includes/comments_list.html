{% load static %}
{% load custom_tags %}

<!-- Custom CSS -->
{% block styles %}
<link rel="stylesheet" href="{% static 'css/blog/comments.css' %}">
{% endblock styles %}

<!-- Количество комментариев -->
<p class="comment_counter"> Комментарии: {{ article.comment.all.count }} </p>

<!-- Блок комментариев -->
<div class="comment_blocks">

    <!-- Если комментарии есть -->
    {% if parents_comments %}

        <!-- Форма добавления комментария -->
        <div class="comments_one_block">
            {% include 'blog/includes/add_comment.html' %}
        </div>

        <!-- Перечень комментариев -->
        {% for comment in parents_comments %}

            <!-- Родительский комментарий -->
            <div class="comments_one_block">
                <!-- Блок комментария -->
                {% include 'blog/includes/one_comment.html' %}
                <!-- Кнопка ответить на комментарий -->
                <div class="right_block">
                    <a href="#" data-index="{{ forloop.counter0 }}" onclick="toggleCommentForm(this)">
                        <button class="send_button" type="submit">Ответить</button>
                    </a>
                </div>
            </div>

            <!-- Форма добавления ответа на комментарий, которая появляется при клике на кнопку Ответить -->
            <div id="commentForm_{{ forloop.counter0 }}" class="comments_one_block hidden">
                {% include 'blog/includes/add_comment.html' %}
            </div>

            <!-- Если есть ответы на родительский комментарий -->
            {% if comment.get_child_comments %}

                <!-- Ссылка для просмотра ответов -->
                <a href="#" class="see_more_link" onclick="showHideChildComments(event)">
                    {% with count=comment.get_child_comments.count %}
                    Смотреть {{ count|pluralize_custom:"ответ" }}
                    {% endwith %}
                </a>

                <!-- Блок с ответами, который будет появляться при нажатии на ссылку -->
                <div id="childComments" style="display: none;" class="comments_list">
                {% for child_comment in comment.get_child_comments %}
                    <div class="answer_one_block">
                        <!-- Блок комментария -->
                        {% include 'blog/includes/one_comment.html' with comment=child_comment %}
                    </div>
                {% endfor %}
                </div>

            {% endif %}

        {% endfor %}

    {% else %}

        <!-- Если комментариев нет -->
        <p class="no_comments">Начните обсуждение этой статьи! Ваш комментарий будет первым.</p>

        <!-- Форма добавления комментария -->
        <div class="comments_one_block">
            {% include 'blog/includes/add_comment.html' %}
        </div>

    {% endif %}
</div>

<!-- Скрипт отображения формы ответа на комментарий при нажатии на кнопку Ответить -->
<script> function toggleCommentForm(element) { event.preventDefault();
    let index = element.dataset.index;
    const form = document.getElementById('commentForm_' + index);
    if (!form) return;
    form.classList.toggle('hidden');}
</script>

<!-- Скрипт отображения ответов на комментарий при нажатии на ссылку -->
<script> function showHideChildComments(event) { event.preventDefault();
    var commentsDiv = document.getElementById("childComments");
    if (commentsDiv.style.display === "none") { commentsDiv.style.display = "block"; }
    else { commentsDiv.style.display = "none"; } }
</script>