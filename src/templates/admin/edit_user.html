{% extends 'base_admin.html' %}
{% load static %}

{% block title %}
<link href="{% static 'css/user.css' %}" rel="stylesheet"/>
<link href="{% static 'css/admin/popup_styles.css' %}" rel="stylesheet"/>
<title>Редактирование пользователя</title>
{% endblock title %}

{% block content %}

    
      <div class="user-container">
        <div class="setting_t">
          <a href="{% url 'admin:list_users' %}" class="back-link">
          <img src="{% static 'img/chevron-left.svg' %}" alt="" />
          </a>
          <h3 class="title_user_btn">Редактирование пользователя</h3>
        </div>
        <form id="editUserForm" action="{% url 'admin:edit-user' user.id %}" method="POST" enctype="multipart/form-data">
          {% csrf_token %}
        <div class="info__about_user">
            <div class="colum1">

                <div class="upload">
                    <input type="file" name="avatar" accept="image/*" id="id_avatar"
                    class="hidden-file-input">
             
                    {% if avatar %}
                        <!-- Если аватар есть -->
                        <div class="photo_user">
                            <label for="id_avatar" >
                                <img src="{{ avatar.url }}"
                                alt="avatar">
                            </label>
                        </div>
                    {% else %}
                        <label for="id_avatar">
                            <!-- Если аватара нет -->
                             <div class ="control">
                            <h4 class="upload_text">2Mb<br />300x300 px.<br />Форматы: jpg, png.</h4>
                            <img src="{% static 'img/icon_upload.svg' %}" alt="Upload Icon" />
                            <h4 class="upload_text_bottum">Загрузка изображения</h4>
                        </label>
                    </div >
                    {% endif %}
                 
                </div>
    
                <div class="error-message mt-0">
                    {% if form.avatar.errors %}
                    <span class="text-danger">{{ form.avatar.errors.0 }}</span>
                    {% endif %}
                </div>

                <h4 class="registration__date">
                    Дата регистрации <span class="date__reg">{{ date_joined|date:"d.m.Y" }}</span>
                  </h4>
                  <h4 class="registration__date">
                    Дата последнего входа <span class="date__reg">{% if user.last_login %}
                      {{ user.last_login|date:"d.m.Y H:i" }}
                  {% else %}
                      Не входил
                  {% endif %}</span>
                  </h4>
                <div class="check">
                    <label> {{ form.is_active }} Активировать аккаунт</label>
                    <label>{{ form.is_admin }} Администратор</label>
                </div>
                
              </div>

              <div class="colum2">
                <span class="name">Имя*</span>
                    {{ form.first_name }}
                    <div class="error-message mt-0">
                        {% if form.first_name.errors %}
                            <span class="text-danger">{{ form.first_name.errors.0 }}</span>
                        {% endif %}
                    </div>
                <span class="name">Email*</span>
                    {{ form.email }}
                    <div class="error-message mt-0">
                        {% if form.email.errors %}
                            <span class="text-danger">{{ form.email.errors.0 }}</span>
                        {% endif %}
                    </div>
              </div>
    
              <div class="colum3">
                <span class="name">Фамилия*</span>
                    {{ form.last_name }}
                    <div class="error-message mt-0">
                        {% if form.last_name.errors %}
                            <span class="text-danger">{{ form.last_name.errors.0 }}</span>
                        {% endif %}
                    </div>


              <span class="name">Пароль*</span>
              <input id="password" class="name-input" type="text" value="*********"
                       disabled>
              <div class="error-message mt-0">
                  {% if form.password.errors %}
                      <span class="text-danger">{{ form.password.errors.0 }}</span>
                  {% endif %}
              </div>
            <button class="change__pasword" 
                    id="change_password"
                    type="button" >Изменить пароль</button>
          </div>
        </div>

        <div class="buttons">
             <!-- Кнопка для удаления с всплывающим окном -->
              <button type="button" class="delete" id="openDeletePopup">Удалить</button>
            <div>
              <a type="button" class="cancel" href="{% url 'admin:edit-user' user.id %}">Отмена</a>
              <button class="save"  type="submit">Сохранить</button>
            </div>
        </div>
      </div>
    </div>

    
    <!-- Попап с подтверждением удаления -->

    <div id="confirmationPopup" class="modal" style="display:none;">
          <div class="modal-content">
              <h5 >Подтвердите удаление?</h5>
              <div class="modal-body">
                  <p>Данный аккаунт будет удален <b>{{user.first_name}}</b></p>
              </div>
              <div class="modal-footer">
                  <button type="button" class="cancel-button" id="closePopup_del">Отмена</button>
                  <button type="button" class="delete-button" id="confirmDelete">Удалить</button>
              </div>
          </div>
  </div>

<!-- Попап для генерации пароля -->
<div id="changePasswordPopup" class="popup" style="display: none;">
    <div class="popup-content">
        <span id="closePopup">&times;</span>
        <h2 class="text-center mb-2">Генератор паролей</h2>
        <div class="popup-group">
            <label for="password-length">Длина пароля:</label>
            <input type="number"
                   id="password-length"
                   name="length_password"
                   class="form-control"
                   value="8"
                   min="8"
                   max="128"
                   required>
        </div>
        <div class="popup-group">
            <label for="change-password-field">Новый пароль:</label>
            <input type="text"
                   name="new_password"
                   id="change-password-field"
                   class="form-control"
                   style="width: 250px"
            >
            <button id="generate-password-btn"
                    class="save-button ms-3"
                    type="button">Сгенерировать новый пароль
            </button>
        </div>

        <div class="action-buttons justify-content-center ">
            <button class="save-button mx-5 my-1"
                    type="button"
                    id="save-password-btn"
            >Сохранить</button>
            <a type="button" class="cancel-button mx-5 my-1"
               href="{% url 'admin:list_users' %}">
                Отмена</a>
        </div>

    </div>
</div>


<script>
    const userId = "{{ user.id }}";

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Генерация пароля
    document.getElementById('generate-password-btn').addEventListener('click', async () => {
        const lengthPassword = document.getElementById('password-length').value;

        try {
            const response = await fetch('/api/v1/generate-password/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ length_password: parseInt(lengthPassword, 10) })
            });

            if (!response.ok) {
                const error = await response.json();
                alert(`Ошибка: ${error.length_password || 'Не удалось сгенерировать пароль'}`);
                return;
            }

            const data = await response.json();
            document.getElementById('change-password-field').value = data.new_password;
        } catch (error) {
            console.error('Ошибка:', error);
        }
    });

// Сохранение пароля
    document.getElementById('save-password-btn').addEventListener('click', async () => {
        const passwordField = document.getElementById('change-password-field');
        const newPassword = passwordField.value;

        try {
            const response = await fetch(`/api/v1/users/${userId}/change-password/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ password: newPassword })
            });

            if (response.ok) {
                document.getElementById('changePasswordPopup').style.display = 'none';
                document.getElementById('change-password-field').value = "";
                document.getElementById("notification-message").innerText = "Пароль успешно обновлён";

                // Показать тост
                const toastElement = document.getElementById('notification-toast');
                const toast = new bootstrap.Toast(toastElement);
                toast.show();
            } else {
                const errorData = await response.json();
                const errorMessages = errorData.password.join("\n");
                alert(`Ошибки поля "Новый пароль":\n${errorMessages}`);
            }
        } catch (error) {
            console.error("Ошибка:", error);
            alert("Произошла ошибка при отправке запроса");
        }
    });

// Открытие попапа смены пароля
    document.getElementById('change_password').addEventListener('click', function () {
        document.getElementById('changePasswordPopup').style.display = 'flex';
    });

// Закрытие попапа смены пароля
    document.getElementById('closePopup').addEventListener('click', function () {
        document.getElementById('changePasswordPopup').style.display = 'none';
    });

    document.addEventListener('click', function (event) {
        let popup = document.querySelector('.popup-content');
        let formPopup = document.getElementById('changePasswordPopup');
        if (formPopup.style.display === 'flex' && !popup.contains(event.target) && event.target.id !== 'change_password') {
            formPopup.style.display = 'none';
        }
    });

// Получаем элементы
    const deleteButton = document.getElementById('openDeletePopup');
    const confirmationPopup = document.getElementById('confirmationPopup');
    const closeButton = document.getElementById('closePopup_del');
    const confirmDeleteButton = document.getElementById('confirmDelete');
    const editUserForm = document.getElementById('editUserForm');

// Открытие попапа
    deleteButton.addEventListener('click', function() {
      confirmationPopup.style.display = 'block';
    });

// Закрытие попапа
    closeButton.addEventListener('click', function() {
      confirmationPopup.style.display = 'none';
    });

// Подтверждение удаления
    confirmDeleteButton.addEventListener('click', async function() {
      try {
            const response = await fetch(`/api/v1/users/${userId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });

            if (response.status === 204) {
                alert('Пользователь успешно удален');
                window.location.href = "{% url 'admin:list_users' %}";
            } else {
                alert('Произошла ошибка при удалении пользователя');
            }
        } catch (error) {
            console.error("Ошибка:", error);
            alert("Произошла ошибка при отправке запроса");
        }

    });

</script>



{% endblock content %}
